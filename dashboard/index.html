<html>
    <head>
        <title>E-Teeka</title>
        <meta charset="utf-8" /> 

        <style>
            /* .table-row {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-around;
            } */
        </style>
    </head>

    <body>

        <div id="list-children-container">
            Parent Bhamashah ID: <input type="text" id="parentBhamashahInput">
            <button id="listChildrenBtn">List children</button>
            <ul id="list-children">
            </ul>
        </div>
        
        <div id="child-vaccine-info">
            <h4>Completed vaccines</h4>
            <table id="completed-vaccines"></table>
            <hr>

            <h4>Due vaccines</h4>
            <table id="due-vaccines"></table>
            <hr>

            <h4>Future vaccines</h4>
            <table id="future-vaccines"></table>
            <hr>
        </div>

        <script>
            // var domainName = 'http://eteeka.herokuapp.com/'
            var domainName = ''
            var username = 'sharma'
            

            /* List vaccination info of a particular child, in a specific category */
            function displayVaccinationInfo(vaccines, target) {
                let innerHTML = ''
                for (let v of vaccines) {
                    console.log(v)

                    innerHTML += `<tr data-v-id="${v._id}">
                                    <td>${v.name}</td>
                                    <td>${v.description}</td>
                                    <td>${v.givenAt}</td>
                                    <td>
                                        <button class='v-toggle-btn'> Toggle </button>
                                    </td>
                                  </tr>
                                `
                }
                document.getElementById(target).innerHTML = innerHTML
            }
            
            /* List vaccination info in all categories */
            async function displayAllVaccinationInfo(childId) {
                try {
                    let response = await fetch(`/getChildInfo?childId=${childId}`)
                    let responseJson = await response.json()

                    console.log(responseJson)
                    
                    displayVaccinationInfo(responseJson.status.completed, 'completed-vaccines')
                    displayVaccinationInfo(responseJson.status.due, 'due-vaccines')
                    displayVaccinationInfo(responseJson.status.future, 'future-vaccines')
                    
                    attachToggleEvents()
                } catch (e) {
                    console.log('error> displayAllVaccinationInfo :', e)
                }
            }
            
            /* Attach event handlers to all toggle events */
            function attachToggleEvents() {
                let allButtons = document.getElementsByClassName('v-toggle-btn')
                for (let each of allButtons) {
                    each.onclick = function(event) {
                        // parent = td -> parent = tr
                        let v_id = event.target.parentElement.parentElement.getAttribute('data-v-id')
                        let status = toggleVaccinationStatus(v_id)
                        console.log(status)
                    }
                }
            }

            /* Make API call to toggle vaccination status for a particular ID */
            async function toggleVaccinationStatus(v_id) {
                console.log(v_id)
                try {
                    let response = await fetch(
                        // '/markVaccine?' + 'vaccineId=' + v_id + '&givenBy=' + username
                        `/markVaccine?vaccineId=${v_id}&givenBy=${username}`
                    )
                    return response.status
                } catch (e) {
                    console.log('some error occured')
                }
            }

            /* Make API call to get children on a bhamashah card */
            async function listChildren(parentBhamashahId) {
                try {
                    // let response = await fetch('/listChildren?parentBhamashahId=' + parentBhamashahId)
                    let response = await fetch(`/listChildren?parentBhamashahId=${parentBhamashahId}`)
                    let responseJson = await response.json()
                    return responseJson
                } catch (e) {
                    console.log('error> listChlidren :', e)
                }
            }

            /* Event handler to list children on a bhamashah card */
            function listChildrenHandler() {
                console.log('attaching listchildren listener')
                var parentBhamashahId = document.getElementById('parentBhamashahInput').value
                document.getElementById('listChildrenBtn').onclick = async function(e) {
                    console.log('listing for', parentBhamashahId)
                    let children = await listChildren(parentBhamashahId)

                    let html = ''
                    for (let child of children) {
                        // html += '<li>' + child.fullName + '<button onclick="displayAllVaccinationInfo(\"' + child._id + '\")">Get info</button>' + '</li>'
                        html += `<li>
                                    ${child.fullName} 
                                    <button onclick='displayAllVaccinationInfo("${child._id}")'>
                                        Get Info
                                    </button>
                                </li>`
                    }
                    document.getElementById('list-children').innerHTML = html
                }
            }

            listChildrenHandler()
            
        </script>
        
    </body>
</html>